#!/usr/bin/env python3

import json
import sys
import os
from pathlib import Path

def load_locus_profiles(profiles_path=None):
    """Load locus profiles from JSON file"""
    if profiles_path is None:
        # Try multiple possible paths
        possible_paths = [
            "scripts/catalogs/loci_profiles.json",
            "/opt/stripy-pipeline/scripts/catalogs/loci_profiles.json",
            "catalogs/loci_profiles.json"
        ]
        
        for path in possible_paths:
            if os.path.exists(path):
                profiles_path = path
                break
        else:
            profiles_path = "scripts/catalogs/loci_profiles.json"
    
    try:
        with open(profiles_path, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"Warning: Could not find {profiles_path}", file=sys.stderr)
        return {}
    except json.JSONDecodeError:
        print(f"Warning: Invalid JSON in {profiles_path}", file=sys.stderr)
        return {}

def expand_locus(locus_arg, profiles):
    """Expand locus argument by replacing profile names with actual loci"""
    if not locus_arg:
        return []
    
    locus_list = [locus.strip() for locus in locus_arg.split(',')]
    expanded_locus = []
    
    for locus in locus_list:
        if locus in profiles:
            expanded_locus.extend(profiles[locus])
        else:
            expanded_locus.append(locus)
    
    return list(set(expanded_locus))

def main():
    if len(sys.argv) < 2:
        print("Usage: stripy [STRipy arguments...]", file=sys.stderr)
        sys.exit(1)
    
    args = sys.argv[1:]
    new_args = []
    locus_expanded = False
    
    # Only process --locus if it's explicitly present
    i = 0
    while i < len(args):
        arg = args[i]
        
        if arg == "--locus" and i + 1 < len(args):
            # Found --locus, expand it
            profiles = load_locus_profiles()
            locus_arg = args[i + 1]
            expanded_locus = expand_locus(locus_arg, profiles)
            new_args.extend(["--locus", ",".join(expanded_locus)])
            locus_expanded = True
            i += 2
        else:
            new_args.append(arg)
            i += 1
    
    if locus_expanded:
        print(f"Expanded locus: {new_args[new_args.index('--locus') + 1]}", file=sys.stderr)
    
    # Execute the actual STRipy command, not ourselves
    os.execvp("python3", ["python3", "/opt/stripy-pipeline/stri.py"] + new_args)

if __name__ == "__main__":
    main()
